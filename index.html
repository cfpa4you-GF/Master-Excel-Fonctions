<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ØªØ¹Ù„Ù… Ø£ÙƒØ³Ù„ Ø¨Ø§Ù„ØªÙ…Ø§Ø±ÙŠÙ†</title>
    
    <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù„Ù€ iOS (iPhone/iPad) -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ø£ÙƒØ³Ù„ Ø¨Ø§Ù„ØªÙ…Ø§Ø±ÙŠÙ†">
    
    <!-- Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù„Ù€ iPhone -->
    <link rel="apple-touch-icon" href="https://upload.wikimedia.org/wikipedia/commons/thumb/3/34/Microsoft_Office_Excel_%282019%E2%80%93present%29.svg/192px-Microsoft_Office_Excel_%282019%E2%80%93present%29.svg.png">

    <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù„Ù€ Android -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="ØªØ¹Ù„Ù… Ø£ÙƒØ³Ù„ Ø¨Ø§Ù„ØªÙ…Ø§Ø±ÙŠÙ†">
    <meta name="theme-color" content="#107c41">

    <!-- Ù…Ù„Ù Manifest Ù…Ø¯Ù…Ø¬ Ù…Ø¹ Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø¥ÙƒØ³Ù„ -->
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogItiq2LnZhNmFINij2YPYs9mEINio2KfZhNiq2YXYp9ix2YrZhiIsCiAgInNob3J0X25hbWUiIjogItiq2LnZhNmFINij2YPYs9mEINio2KfZhNiq2YXYp9ix2YrZhiIsCiAgInN0YXJ0X3VybCI6ICIuIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjMTA3YzQxIiwKICAidGhlbWVfY29sb3IiOiAiIzEwN2M0MSIsCiAgImljb25zIjogWwogICAgewogICAgICAic3JjIjogImh0dHBzOi8vdXBsb2FkLndpa2ltZWRpYS5vcmcvd2lraXBlZGlhL2NvbW1vbnMvdGh1bWIvMy8zNC9NaWNyb3NvZnRfT2ZmaWNlX0V4Y2VsXyUyODIwMTklRTIlODAlOTRwcmVzZW50JTI5LnN2Zy8xOTJweC1NaWNyb3NvZnRfT2ZmaWNlX0V4Y2VsXyUyODIwMTklRTIlODAlOTRwcmVzZW50JTI5LnN2Zy5wbmciLAogICAgICAic2l6ZXMiIjogIjE5MngxOTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9wbmciCiAgICB9LAogICAgewogICAgICAic3JjIjogImh0dHBzOi8vdXBsb2FkLndpa2ltZWRpYS5vcmcvd2lraXBlZGlhL2NvbW1vbnMvdGh1bWIvMy8zNC9NaWNyb3NvZnRfT2ZmaWNlX0V4Y2VsXyUyODIwMTklRTIlODAlOTRwcmVzZW50JTI5LnN2Zy81MTJweC1NaWNyb3NvZnRfT2ZmaWNlX0V4Y2VsXyUyODIwMTklRTIlODAlOTRwcmVzZW50JTI5LnN2Zy5wbmciLAogICAgICAic2l6ZXMiIjogIjUxMng1MTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9wbmciCiAgICB9CiAgXQp9">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        excelGreen: '#107c41',
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Tajawal', sans-serif;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: contain;
            transition: background-color 0.3s ease;
        }
        
        /* Light Mode Default */
        body { background-color: #f3f4f6; color: #1f2937; }
        
        /* Dark Mode Global Styles */
        .dark body { background-color: #111827; color: #f9fafb; }
        .dark .bg-white { background-color: #1f2937; }
        .dark .text-gray-800 { color: #f3f4f6; }
        .dark .text-gray-500 { color: #9ca3af; }
        .dark .border-gray-100, .dark .border-gray-200 { border-color: #374151; }
        .dark .bg-gray-50 { background-color: #374151; }
        .dark .bg-slate-50 { background-color: #111827; }

        .excel-green { background-color: #107c41; }
        .text-excel { color: #107c41; }
        
        .excel-grid {
            border-collapse: collapse;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            direction: ltr;
        }
        .excel-grid td, .excel-grid th {
            border: 1px solid #d1d5db;
            padding: 4px 8px;
            font-size: 12px;
        }
        .dark .excel-grid td, .dark .excel-grid th { border-color: #4b5563; }

        .excel-grid th {
            background-color: #f8fafc;
            color: #64748b;
            font-weight: bold;
            text-align: center;
        }
        .dark .excel-grid th { background-color: #1f2937; color: #9ca3af; }

        .success-bg { background-color: #dcfce7; color: #166534; }
        .dark .success-bg { background-color: #064e3b; color: #6ee7b7; }
        .error-bg { background-color: #fee2e2; color: #991b1b; }
        .dark .error-bg { background-color: #7f1d1d; color: #fca5a5; }

        .ltr { direction: ltr; text-align: left; }
        
        .category-tab.active {
            border-bottom: 3px solid #107c41;
            color: #107c41;
            font-weight: bold;
        }
        .dark .category-tab.active { color: #34d399; border-color: #34d399; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        .excel-ui-box {
            background: #fff;
            border: 1px solid #c0c0c0;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.05);
            border-radius: 4px;
            overflow: hidden;
        }
        .dark .excel-ui-box { background: #1f2937; border-color: #4b5563; }

        .excel-formula-bar {
            background: #fff;
            border-bottom: 1px solid #e0e0e0;
            padding: 6px 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: monospace;
            font-size: 13px;
            color: #333;
        }
        .dark .excel-formula-bar { background: #374151; border-color: #4b5563; color: #e5e7eb; }

        #floatingHome {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform: scale(0);
        }
        #floatingHome.visible { transform: scale(1); }
        
        .mode-icon { transition: transform 0.5s ease; }
        .dark .mode-icon { transform: rotate(360deg); }
    </style>
</head>
<body class="pb-24 transition-colors duration-300">

    <!-- Floating Home Button -->
    <button id="floatingHome" onclick="goHome()" class="fixed bottom-6 left-6 z-[60] w-14 h-14 excel-green text-white rounded-full shadow-2xl flex items-center justify-center hover:scale-110 active:scale-95">
        <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
        </svg>
    </button>

    <!-- Header Section -->
    <header class="excel-green text-white p-4 shadow-md sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-lg font-bold flex items-center gap-2">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M2 10a8 8 0 018-8v8h8a8 8 0 11-16 0z"></path><path d="M12 2.252A8.014 8.014 0 0117.748 8H12V2.252z"></path></svg>
                Excel Master (FR)
            </h1>
            <div class="flex items-center gap-3">
                <!-- Dark Mode Toggle -->
                <button onclick="toggleDarkMode()" class="p-2 bg-white/10 rounded-full hover:bg-white/20 transition-all mode-icon" title="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹">
                    <svg id="darkIcon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z"></path></svg>
                    <svg id="lightIcon" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                </button>
                <div id="scoreBadge" class="bg-white/20 px-3 py-1 rounded-full text-sm font-bold">
                    ğŸ† <span id="userPoints">0</span>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4">
        
        <!-- Dashboard -->
        <div id="dashboard">
            <div class="bg-white dark:bg-gray-800 rounded-2xl p-4 shadow-sm mb-4 border border-gray-100 dark:border-gray-700 flex items-center justify-center gap-3">
                <span class="text-gray-700 dark:text-gray-300 font-medium text-sm">ØªØ¹Ù„Ù… Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¥ÙƒØ³Ù„ Ù…Ø¹:</span>
                <div class="flex items-center gap-2 bg-gray-50 dark:bg-gray-700 px-3 py-1.5 rounded-full border border-gray-200 dark:border-gray-600">
                    <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 16C14.2091 16 16 14.2091 16 12C16 9.79086 14.2091 8 12 8C9.79086 8 8 9.79086 8 12C8 14.2091 9.79086 16 12 16Z" stroke="url(#insta_grad)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M3 16V8C3 5.23858 5.23858 3 8 3H16C18.7614 3 21 5.23858 21 8V16C21 18.7614 18.7614 21 16 21H8C5.23858 21 3 18.7614 3 16Z" stroke="url(#insta_grad)" stroke-width="2"/>
                        <path d="M17.5 6.51L17.51 6.49889" stroke="url(#insta_grad)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <defs>
                            <linearGradient id="insta_grad" x1="3" y1="21" x2="21" y2="3" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#fdf497"/>
                                <stop offset="0.05" stop-color="#fdf497"/>
                                <stop offset="0.45" stop-color="#fd5949"/>
                                <stop offset="0.6" stop-color="#d6249f"/>
                                <stop offset="0.9" stop-color="#285AEB"/>
                            </linearGradient>
                        </defs>
                    </svg>
                    <span class="font-bold text-gray-800 dark:text-gray-100 text-sm ltr">prof.i3lam_ali</span>
                </div>
            </div>

            <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-sm mb-6 flex justify-between items-center">
                <div>
                    <h2 class="text-xl font-bold text-gray-800 dark:text-white">ØªØ¹Ù„Ù… Ø¨Ø§Ù„ØªÙ…Ø§Ø±ÙŠÙ†</h2>
                    <p class="text-gray-500 dark:text-gray-400 text-sm">Ø§Ø®ØªØ± ÙØ¦Ø© Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù…Ù‡Ø§Ø±Ø§ØªÙƒ</p>
                </div>
                <button onclick="toggleLibrary()" class="bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-400 px-4 py-2 rounded-xl font-bold text-sm flex items-center gap-2 hover:bg-amber-200 transition-colors">
                    ğŸ“– Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø´Ø±Ø­ (FR)
                </button>
            </div>
            
            <div class="grid grid-cols-2 gap-4 mb-6" id="categoriesGrid"></div>

            <button onclick="startFullQuiz()" class="w-full bg-blue-600 text-white p-5 rounded-2xl shadow-lg flex justify-between items-center group overflow-hidden relative">
                <div class="relative z-10 text-right">
                    <h4 class="font-bold text-lg">Ø§Ø®ØªØ¨Ø§Ø± Ø´Ø§Ù…Ù„ (6 ÙØ¦Ø§Øª)</h4>
                    <p class="text-blue-100 text-xs mt-1">ØªÙ…Ø±ÙŠÙ† ÙˆØ§Ø­Ø¯ Ù…Ù† ÙƒÙ„ ØªØ®ØµØµ</p>
                </div>
                <span class="text-3xl relative z-10">ğŸš€</span>
                <div class="absolute inset-0 bg-blue-700 translate-y-full group-hover:translate-y-0 transition-transform"></div>
            </button>
        </div>

        <!-- Library View -->
        <div id="libraryView" class="hidden">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-2xl font-bold text-gray-800 dark:text-white text-right">Ù‚Ø§Ù…ÙˆØ³ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø¨Ø§Ù„ÙØ±Ù†Ø³ÙŠØ©</h2>
                <button onclick="toggleLibrary()" class="text-gray-400 font-bold hover:text-red-500 transition-colors">Ø¥ØºÙ„Ø§Ù‚ âœ–</button>
            </div>

            <div class="mb-6 bg-white dark:bg-gray-800 p-4 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700">
                <label class="block text-xs font-bold text-gray-400 mb-2 uppercase tracking-wider">Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø³Ø±ÙŠØ¹ Ø¹Ù† Ø¯Ø§Ù„Ø©</label>
                <div class="relative">
                    <select id="functionSearch" onchange="searchFunction(this.value)" class="w-full p-3 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl text-gray-700 dark:text-white outline-none focus:ring-2 focus:ring-excel-green transition-all appearance-none">
                        <option value="">Ø§Ø®ØªØ± Ø¯Ø§Ù„Ø© Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©...</option>
                    </select>
                </div>
            </div>
            
            <div class="flex overflow-x-auto gap-4 mb-6 pb-2 no-scrollbar border-b border-gray-200 dark:border-gray-700" id="libraryTabs"></div>
            <div id="libraryContent" class="space-y-6 animate-in fade-in duration-300"></div>
        </div>

        <!-- Quiz Interface -->
        <div id="quizView" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <button onclick="goHome()" class="text-gray-400">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
                <div class="px-4 py-1 bg-blue-50 dark:bg-blue-900/30 rounded-full text-blue-600 dark:text-blue-300 font-bold text-xs" id="quizCatName">Ø§Ù„ÙØ¦Ø©</div>
                <div id="quizStepCounter" class="text-xs text-gray-400 font-bold">1 / 6</div>
            </div>

            <div class="bg-white dark:bg-gray-800 rounded-3xl p-6 shadow-xl border border-gray-100 dark:border-gray-700">
                <h3 id="quizQuestion" class="text-lg font-bold text-gray-800 dark:text-white mb-6"></h3>
                
                <div class="overflow-x-auto mb-6 bg-slate-50 dark:bg-gray-900 rounded-xl p-2 border border-slate-100 dark:border-gray-700">
                    <table class="excel-grid w-full" id="quizTable"></table>
                </div>

                <div class="space-y-4">
                    <div class="flex flex-col gap-2">
                        <label class="text-xs font-bold text-gray-400 mr-1 uppercase tracking-wider">Formule Excel (FranÃ§ais)</label>
                        <input type="text" id="quizInput" style="direction: ltr; text-align: left;" spellcheck="false" class="w-full p-4 bg-gray-50 dark:bg-gray-700 border-2 border-transparent focus:border-blue-500 rounded-2xl font-mono text-blue-800 dark:text-blue-300 outline-none transition-all" placeholder="=FONCTION(...)">
                    </div>
                    <div id="quizFeedback" class="hidden p-4 rounded-2xl text-sm font-bold text-center animate-bounce"></div>
                    <button id="submitBtn" onclick="checkAnswer()" class="w-full py-4 excel-green text-white rounded-2xl font-bold shadow-lg shadow-green-100 dark:shadow-none active:scale-95 transition-all">ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©</button>
                    <button id="nextBtn" onclick="nextQuestion()" class="hidden w-full py-4 bg-blue-600 text-white rounded-2xl font-bold">Ø§Ù„ØªÙ…Ø±ÙŠÙ† Ø§Ù„ØªØ§Ù„ÙŠ â”</button>
                </div>
            </div>
        </div>

        <!-- Result View -->
        <div id="resultView" class="hidden text-center py-10">
            <div class="text-7xl mb-6">ğŸŠ</div>
            <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-2">Ø£Ø­Ø³Ù†Øª ÙŠØ§ Ø¨Ø·Ù„!</h2>
            <p class="text-gray-500 mb-8 px-10">Ù„Ù‚Ø¯ Ø£ØªÙ…Ù…Øª Ø§Ù„ØªÙ…Ø§Ø±ÙŠÙ† Ø¨Ù†Ø¬Ø§Ø­.</p>
            <div class="bg-white dark:bg-gray-800 p-6 rounded-3xl shadow-sm border border-gray-100 dark:border-gray-700 inline-block mb-8">
                <div class="text-xs text-gray-400 uppercase font-bold mb-1">Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©</div>
                <div class="text-4xl font-black text-excelGreen" id="finalScore">0</div>
            </div>
            <br>
            <button onclick="goHome()" class="px-10 py-4 bg-gray-800 dark:bg-gray-700 text-white rounded-2xl font-bold">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
        </div>
    </main>

    <script>
        const categories = {
            math: { name: "Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª", icon: "ğŸ“", color: "blue", 
                functions: [
                    { name: "SOMME", desc: "ØªÙ‚ÙˆÙ… Ø¨Ø¬Ù…Ø¹ ÙƒØ§ÙØ© Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙÙŠ Ù†Ø·Ø§Ù‚ Ù…Ù† Ø§Ù„Ø®Ù„Ø§ÙŠØ§.", syntax: "=SOMME(plage)", example: "=SOMME(B1:B3)", uiData: { h: ['A (Items)', 'B (Prix)'], b: [['PC', '1200'], ['Souris', '25'], ['Clavier', '50']], target: 'B4', result: '1275' }, detail: "ØªØ¬Ù…Ø¹ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± ÙÙŠ Ø§Ù„Ø¹Ù…ÙˆØ¯ B Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ." },
                    { name: "PRODUIT", desc: "Ø¶Ø±Ø¨ ÙƒØ§ÙØ© Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙƒÙˆØ³Ø·Ø§Ø¡.", syntax: "=PRODUIT(plage)", example: "=PRODUIT(A2:B2)", uiData: { h: ['A (QtÃ©)', 'B (Prix)'], b: [['5', '10']], target: 'C2', result: '50' }, detail: "ØªØ¶Ø±Ø¨ Ø§Ù„ÙƒÙ…ÙŠØ© ÙÙŠ Ø§Ù„Ø³Ø¹Ø± Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©." },
                    { name: "ARRONDI", desc: "ØªÙ‚Ø±ÙŠØ¨ Ø±Ù‚Ù… Ø¥Ù„Ù‰ Ø¹Ø¯Ø¯ Ù…Ø­Ø¯Ø¯ Ù…Ù† Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø´Ø±ÙŠØ©.", syntax: "=ARRONDI(nombre; num_chiffres)", example: "=ARRONDI(A1; 2)", uiData: { h: ['A (Valeur)'], b: [['15,6789']], target: 'B1', result: '15,68' }, detail: "ØªÙ‚Ø±Ø¨ Ø§Ù„Ø±Ù‚Ù… 15,6789 Ø¥Ù„Ù‰ Ù…Ù†Ø²Ù„ØªÙŠÙ† Ø¹Ø´Ø±ÙŠØªÙŠÙ†." },
                    { name: "MOYENNE", desc: "Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ØªÙˆØ³Ø· Ø§Ù„Ø­Ø³Ø§Ø¨ÙŠ Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ù† Ø§Ù„Ù‚ÙŠÙ….", syntax: "=MOYENNE(plage)", example: "=MOYENNE(A1:A3)", uiData: { h: ['A (Notes)'], b: [['10'], ['15'], ['11']], target: 'A4', result: '12' }, detail: "ØªØ­Ø³Ø¨ Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª ÙÙŠ Ø§Ù„Ø¹Ù…ÙˆØ¯ A." },
                    { name: "SOMME.SI", desc: "Ø¬Ù…Ø¹ Ø§Ù„Ø®Ù„Ø§ÙŠØ§ Ø§Ù„ØªÙŠ ØªØ­Ù‚Ù‚ Ù…Ø¹ÙŠØ§Ø±Ø§Ù‹ Ù…Ø¹ÙŠÙ†Ø§Ù‹.", syntax: "=SOMME.SI(plage; critÃ¨re)", example: "=SOMME.SI(A1:A3; \">50\")", uiData: { h: ['A (Valeur)'], b: [['10'], ['60'], ['80']], target: 'B1', result: '140' }, detail: "ØªØ¬Ù…Ø¹ ÙÙ‚Ø· Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø£ÙƒØ¨Ø± Ù…Ù† 50 (60+80)." }
                ],
                quiz: {
                    q: "Ø§Ø¬Ù…Ø¹ Ø£Ø³Ø¹Ø§Ø± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ø§Ù„Ø¹Ù…ÙˆØ¯ B (Ù…Ù† Ø§Ù„Ø³Ø·Ø± 1 Ø¥Ù„Ù‰ 3).",
                    table: { h: ['A (Produit)', 'B (Prix)'], b: [['PC', '1200'], ['Clavier', '50'], ['Souris', '25']] },
                    correct: ["=SOMME(B1:B3)"], points: 10
                }
            },
            logic: { name: "Ø§Ù„Ù…Ù†Ø·Ù‚", icon: "ğŸ§ ", color: "purple", 
                functions: [
                    { name: "SI", desc: "ØªØªØ­Ù‚Ù‚ Ù…Ù† Ø´Ø±Ø· ÙˆØªØ¹ÙŠØ¯ Ù‚ÙŠÙ…Ø© Ù„Ù„ØµØ­ ÙˆØ£Ø®Ø±Ù‰ Ù„Ù„Ø®Ø·Ø£.", syntax: "=SI(test; vrai; faux)", example: "=SI(A1>=10; \"Admis\"; \"RefusÃ©\")", uiData: { h: ['A (Moyenne)'], b: [['12']], target: 'B1', result: 'Admis' }, detail: "Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø¹Ø¯Ù„ 10 Ø£Ùˆ Ø£ÙƒØ«Ø±ØŒ ÙŠØ¸Ù‡Ø± Ø§Ù„Ø·Ø§Ù„Ø¨ ÙƒÙ€ Admis." },
                    { name: "SI.ERREUR", desc: "Ø¥Ø±Ø¬Ø§Ø¹ Ù‚ÙŠÙ…Ø© ØªØ­Ø¯Ø¯Ù‡Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ØµÙŠØºØ© ØªØ¹Ø·ÙŠ Ø®Ø·Ø£.", syntax: "=SI.ERREUR(val; si_err)", example: "=SI.ERREUR(A1/B1; 0)", uiData: { h: ['A (Dividende)', 'B (Diviseur)'], b: [['10', '0']], target: 'C1', result: '0' }, detail: "ØªØ¹Ø±Ø¶ 0 Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ø®Ø·Ø£ #DIV/0! ÙÙŠ Ø­Ø§Ù„ ÙƒØ§Ù†Øª Ø§Ù„Ù‚Ø³Ù…Ø© Ø¹Ù„Ù‰ ØµÙØ±." }
                ],
                quiz: {
                    q: "Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¹Ù„Ø§Ù…Ø© ÙÙŠ A1 Ø£ÙƒØ¨Ø± Ù…Ù† Ø£Ùˆ ØªØ³Ø§ÙˆÙŠ 10ØŒ Ø§ÙƒØªØ¨ 'ReÃ§u'ØŒ ÙˆØ¥Ù„Ø§ Ø§ÙƒØªØ¨ 'Ã‰chouÃ©'.",
                    table: { h: ['A (Note)'], b: [['14']] },
                    correct: ["=SI(A1>=10;\"REÃ‡U\";\"Ã‰CHOUÃ‰\")", "=SI(A1>=10;\"RECU\";\"ECHOUÃ‰\")"], points: 15
                }
            },
            text: { name: "Ø§Ù„Ù†ØµÙˆØµ", icon: "ğŸ“", color: "yellow", 
                functions: [
                    { name: "CONCAT", desc: "Ø¯Ù…Ø¬ Ø¹Ø¯Ø© Ù†ØµÙˆØµ ÙÙŠ Ø³Ù„Ø³Ù„Ø© ÙˆØ§Ø­Ø¯Ø©.", syntax: "=CONCAT(t1; t2)", example: "=CONCAT(A1; \" \"; B1)", uiData: { h: ['A (Nom)', 'B (PrÃ©nom)'], b: [['Ali', 'Ahmed']], target: 'C1', result: 'Ali Ahmed' }, detail: "ØªØ¯Ù…Ø¬ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù„Ù‚Ø¨ Ù…Ø¹ Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ†Ù‡Ù…Ø§." },
                    { name: "NBCAR", desc: "Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø±ÙˆÙ ÙÙŠ Ø§Ù„Ù†Øµ.", syntax: "=NBCAR(texte)", example: "=NBCAR(A1)", uiData: { h: ['A (Word)'], b: [['Excel']], target: 'B1', result: '5' }, detail: "ØªØ­Ø³Ø¨ Ø·ÙˆÙ„ ÙƒÙ„Ù…Ø© Excel." }
                ],
                quiz: {
                    q: "Ù‚Ù… Ø¨Ø¯Ù…Ø¬ Ø§Ù„Ø§Ø³Ù… (A1) ÙˆØ§Ù„Ù„Ù‚Ø¨ (B1) Ù…Ø¹ ÙˆØ¶Ø¹ Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ†Ù‡Ù…Ø§.",
                    table: { h: ['A (Nom)', 'B (PrÃ©nom)'], b: [['Ahmed', 'Ali']] },
                    correct: ["=CONCAT(A1;\" \";B1)", "=A1&\" \"&B1"], points: 10
                }
            },
            lookup: { name: "Ø§Ù„Ø¨Ø­Ø«", icon: "ğŸ”", color: "red", 
                functions: [
                    { name: "RECHERCHEV", desc: "Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø±Ø£Ø³ÙŠ Ø¹Ù† Ù‚ÙŠÙ…Ø© ÙÙŠ Ø¹Ù…ÙˆØ¯.", syntax: "=RECHERCHEV(v; table; col; [mode])", example: "=RECHERCHEV(\"PC\"; A1:B3; 2; 0)", uiData: { h: ['A (Prod)', 'B (Prix)'], b: [['PC', '500'], ['TV', '300']], target: 'D1', result: '500' }, detail: "ØªØ¨Ø­Ø« Ø¹Ù† Ø³Ø¹Ø± Ø§Ù„Ù€ PC ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„." }
                ],
                quiz: {
                    q: "Ø§Ø¨Ø­Ø« Ø¹Ù† Ø³Ø¹Ø± 'PC' (Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ A1:B3) Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¯Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ù…ÙˆØ¯ÙŠ.",
                    table: { h: ['A (Nom)', 'B (Prix)'], b: [['PC', '5000'], ['TEL', '1200'], ['TAB', '800']] },
                    correct: ["=RECHERCHEV(\"PC\";A1:B3;2;0)", "=RECHERCHEV(\"PC\";A1:B3;2;FAUX)"], points: 20
                }
            },
            stat: { name: "Ø§Ù„Ø¥Ø­ØµØ§Ø¡", icon: "ğŸ“Š", color: "green", 
                functions: [
                    { name: "MAX", desc: "Ø¥Ø±Ø¬Ø§Ø¹ Ø£ÙƒØ¨Ø± Ù‚ÙŠÙ…Ø© ÙÙŠ Ù…Ø¬Ù…ÙˆØ¹Ø©.", syntax: "=MAX(plage)", example: "=MAX(A1:A3)", uiData: { h: ['A (Values)'], b: [['5'], ['50'], ['12']], target: 'A4', result: '50' }, detail: "ØªØ­Ø¯Ø¯ Ø£Ø¹Ù„Ù‰ Ø±Ù‚Ù… ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©." }
                ],
                quiz: {
                    q: "Ø£ÙˆØ¬Ø¯ Ø£ÙƒØ¨Ø± Ù‚ÙŠÙ…Ø© (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰) ÙÙŠ Ù†Ø·Ø§Ù‚ Ø§Ù„Ø®Ù„Ø§ÙŠØ§ Ù…Ù† A1 Ø¥Ù„Ù‰ A4.",
                    table: { h: ['A (Scores)'], b: [['85'], ['92'], ['78'], ['95']] },
                    correct: ["=MAX(A1:A4)"], points: 10
                }
            },
            date: { name: "Ø§Ù„ØªØ§Ø±ÙŠØ®", icon: "ğŸ“…", color: "indigo", 
                functions: [
                    { name: "ANNEE", desc: "Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø±Ù‚Ù… Ø§Ù„Ø³Ù†Ø© Ù…Ù† ØªØ§Ø±ÙŠØ®.", syntax: "=ANNEE(date)", example: "=ANNEE(A1)", uiData: { h: ['A (Date)'], b: [['20/05/2024']], target: 'B1', result: '2024' }, detail: "ØªØ³ØªØ®Ø±Ø¬ Ø§Ù„Ø³Ù†Ø© ÙÙ‚Ø· ÙƒØ±Ù‚Ù…." }
                ],
                quiz: {
                    q: "Ø§Ø³ØªØ®Ø±Ø¬ Ø±Ù‚Ù… 'Ø§Ù„Ø³Ù†Ø©' Ù…Ù† Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ø®Ù„ÙŠØ© A1.",
                    table: { h: ['A (Date)'], b: [['18/12/2025']] },
                    correct: ["=ANNEE(A1)"], points: 10
                }
            }
        };

        let currentQuizQueue = [];
        let currentStep = 0;
        let sessionScore = 0;
        let totalPoints = parseInt(localStorage.getItem('excelPoints') || 0);
        let activeLibraryCat = 'math';

        function init() {
            // Restore Dark Mode
            if (localStorage.getItem('darkMode') === 'enabled') {
                document.documentElement.classList.add('dark');
                document.getElementById('darkIcon').classList.remove('hidden');
                document.getElementById('lightIcon').classList.add('hidden');
            }

            const grid = document.getElementById('categoriesGrid');
            if(grid) {
                grid.innerHTML = '';
                Object.keys(categories).forEach(key => {
                    const cat = categories[key];
                    const div = document.createElement('div');
                    div.className = `bg-white dark:bg-gray-800 p-5 rounded-2xl shadow-sm border-b-4 border-${cat.color}-500 flex flex-col items-center cursor-pointer active:scale-95 transition-all hover:shadow-md`;
                    div.onclick = () => startSingleQuiz(key);
                    div.innerHTML = `<span class="text-3xl mb-2">${cat.icon}</span><span class="font-bold text-gray-800 dark:text-white text-sm">${cat.name}</span>`;
                    grid.appendChild(div);
                });
            }
            document.getElementById('userPoints').innerText = totalPoints;
            buildLibraryTabs();
            populateSearchList();
            updateFloatingButtonVisibility();
        }

        function toggleDarkMode() {
            const isDark = document.documentElement.classList.toggle('dark');
            const darkIcon = document.getElementById('darkIcon');
            const lightIcon = document.getElementById('lightIcon');
            
            if (isDark) {
                localStorage.setItem('darkMode', 'enabled');
                darkIcon.classList.remove('hidden');
                lightIcon.classList.add('hidden');
            } else {
                localStorage.setItem('darkMode', 'disabled');
                darkIcon.classList.add('hidden');
                lightIcon.classList.remove('hidden');
            }
        }

        function populateSearchList() {
            const select = document.getElementById('functionSearch');
            if (!select) return;
            let allFuncs = [];
            Object.keys(categories).forEach(catKey => {
                categories[catKey].functions.forEach(f => {
                    allFuncs.push({ name: f.name, cat: catKey });
                });
            });
            allFuncs.sort((a, b) => a.name.localeCompare(b.name));
            select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø¯Ø§Ù„Ø© Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©...</option>';
            allFuncs.forEach(item => {
                const opt = document.createElement('option');
                opt.value = `${item.cat}|${item.name}`;
                opt.innerText = item.name;
                select.appendChild(opt);
            });
        }

        function searchFunction(value) {
            if (!value) return;
            const [catKey, funcName] = value.split('|');
            activeLibraryCat = catKey;
            buildLibraryTabs();
            renderLibraryContent(catKey);
            setTimeout(() => {
                const element = document.getElementById(`func-card-${funcName}`);
                if (element) element.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }

        function buildLibraryTabs() {
            const tabsContainer = document.getElementById('libraryTabs');
            tabsContainer.innerHTML = '';
            Object.keys(categories).forEach(key => {
                const cat = categories[key];
                const btn = document.createElement('button');
                btn.className = `category-tab px-4 py-2 whitespace-nowrap transition-all ${activeLibraryCat === key ? 'active' : 'text-gray-400'}`;
                btn.onclick = () => {
                    activeLibraryCat = key;
                    buildLibraryTabs();
                    renderLibraryContent(key);
                };
                btn.innerText = `${cat.icon} ${cat.name}`;
                tabsContainer.appendChild(btn);
            });
        }

        function renderLibraryContent(catKey) {
            const libContent = document.getElementById('libraryContent');
            const cat = categories[catKey];
            libContent.innerHTML = '';
            cat.functions.forEach(func => {
                const card = document.createElement('div');
                card.id = `func-card-${func.name}`;
                card.className = `bg-white dark:bg-gray-800 p-6 rounded-3xl shadow-sm border-r-8 border-${cat.color}-500 mb-6`;
                card.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="font-black text-2xl text-${cat.color}-600">f() ${func.name}</h4>
                    </div>
                    <p class="text-gray-800 dark:text-gray-200 text-lg mb-6 font-bold text-right">${func.desc}</p>
                    <div class="excel-ui-box mb-4">
                        <div class="excel-formula-bar ltr"><span class="text-green-600">fx</span> | ${func.example}</div>
                        <div class="p-2 bg-slate-50 dark:bg-gray-900">
                             <table class="excel-grid w-full">
                                <thead><tr><th></th>${func.uiData.h.map(h => `<th>${h}</th>`).join('')}</tr></thead>
                                <tbody>${func.uiData.b.map((row, i) => `<tr><th>${i+1}</th>${row.map(c => `<td>${c}</td>`).join('')}</tr>`).join('')}</tbody>
                             </table>
                        </div>
                    </div>
                    <div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-xl ltr mb-4">
                        <code class="text-blue-700 dark:text-blue-300 font-bold">${func.syntax}</code>
                    </div>
                    <p class="text-sm text-gray-600 dark:text-gray-400 text-right font-medium">${func.detail}</p>
                `;
                libContent.appendChild(card);
            });
        }

        function toggleLibrary() {
            const dash = document.getElementById('dashboard');
            const lib = document.getElementById('libraryView');
            if (lib.classList.contains('hidden')) {
                dash.classList.add('hidden');
                lib.classList.remove('hidden');
                renderLibraryContent(activeLibraryCat);
            } else {
                lib.classList.add('hidden');
                dash.classList.remove('hidden');
            }
            updateFloatingButtonVisibility();
        }

        function startFullQuiz() {
            currentQuizQueue = Object.keys(categories);
            currentStep = 0; sessionScore = 0; showQuiz();
        }

        function startSingleQuiz(key) {
            currentQuizQueue = [key];
            currentStep = 0; sessionScore = 0; showQuiz();
        }

        function showQuiz() {
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('libraryView').classList.add('hidden');
            document.getElementById('resultView').classList.add('hidden');
            document.getElementById('quizView').classList.remove('hidden');
            loadQuestion();
            updateFloatingButtonVisibility();
        }

        function loadQuestion() {
            const catKey = currentQuizQueue[currentStep];
            const data = categories[catKey];
            const quiz = data.quiz;
            document.getElementById('quizCatName').innerText = data.name;
            document.getElementById('quizStepCounter').innerText = `${currentStep + 1} / ${currentQuizQueue.length}`;
            document.getElementById('quizQuestion').innerText = quiz.q;
            document.getElementById('quizInput').value = "";
            document.getElementById('quizFeedback').classList.add('hidden');
            document.getElementById('nextBtn').classList.add('hidden');
            document.getElementById('submitBtn').classList.remove('hidden');
            const table = document.getElementById('quizTable');
            table.innerHTML = `<thead><tr><th></th>${quiz.table.h.map(h => `<th>${h}</th>`).join('')}</tr></thead>
                               <tbody>${quiz.table.b.map((r, i) => `<tr><th>${i+1}</th>${r.map(c => `<td>${c}</td>`).join('')}</tr>`).join('')}</tbody>`;
        }

        function checkAnswer() {
            const input = document.getElementById('quizInput').value.trim().replace(/\s/g, '').toUpperCase();
            const quiz = categories[currentQuizQueue[currentStep]].quiz;
            const feedback = document.getElementById('quizFeedback');
            const isCorrect = quiz.correct.some(ans => ans.replace(/\s/g, '').toUpperCase() === input);
            feedback.classList.remove('hidden', 'success-bg', 'error-bg');
            if(isCorrect) {
                feedback.innerText = "Ø±Ø§Ø¦Ø¹! Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø© âœ…";
                feedback.classList.add('success-bg');
                sessionScore += quiz.points;
                totalPoints += quiz.points;
                updatePoints();
                document.getElementById('submitBtn').classList.add('hidden');
                document.getElementById('nextBtn').classList.remove('hidden');
            } else {
                feedback.innerText = "Ù„Ù„Ø£Ø³ÙØŒ Ø§Ù„ØµÙŠØºØ© Ø®Ø§Ø·Ø¦Ø© âŒ";
                feedback.classList.add('error-bg');
            }
        }

        function nextQuestion() {
            if(currentStep < currentQuizQueue.length - 1) {
                currentStep++; loadQuestion();
            } else {
                showResults();
            }
        }

        function showResults() {
            document.getElementById('quizView').classList.add('hidden');
            document.getElementById('resultView').classList.remove('hidden');
            document.getElementById('finalScore').innerText = sessionScore;
            updateFloatingButtonVisibility();
        }

        function updatePoints() {
            document.getElementById('userPoints').innerText = totalPoints;
            localStorage.setItem('excelPoints', totalPoints);
        }

        function goHome() {
            document.getElementById('quizView').classList.add('hidden');
            document.getElementById('resultView').classList.add('hidden');
            document.getElementById('libraryView').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            updateFloatingButtonVisibility();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function updateFloatingButtonVisibility() {
            const floatingBtn = document.getElementById('floatingHome');
            const dash = document.getElementById('dashboard');
            if (dash.classList.contains('hidden')) floatingBtn.classList.add('visible');
            else floatingBtn.classList.remove('visible');
        }

        window.onload = init;
    </script>
</body>
</html>   